<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Echo Â· å›å“ | æ½œæ„è¯†æ˜ å°„</title>
    
    <!-- èµ„æºé¢„åŠ è½½ä¼˜åŒ–ï¼ˆDNSé¢„è§£æï¼‰ -->
    <link rel="dns-prefetch" href="https://cdn.tailwindcss.com">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://unpkg.com">
    
    <!-- ä½¿ç”¨Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ä½¿ç”¨ç³»ç»Ÿå­—ä½“ï¼Œé¿å…åŠ è½½å¤–éƒ¨å­—ä½“ -->
    <style>
        @font-face {
            font-family: 'Noto Serif SC';
            src: local('PingFang SC'), local('Microsoft YaHei'), local('SimSun');
        }
        @font-face {
            font-family: 'Inter';
            src: local('PingFang SC'), local('Microsoft YaHei'), local('Arial');
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        void: '#050511',     // è™šç©ºé»‘
                        gold: '#D4AF37',     // å¤å¤é‡‘
                        lavender: '#E6E6FA', // è–°è¡£è‰é›¾
                        nebula: '#2D1B4E',   // æ˜Ÿäº‘ç´«
                    },
                    fontFamily: {
                        serif: ['"Noto Serif SC"', 'serif'],
                        sans: ['"Inter"', 'sans-serif'],
                    },
                    animation: {
                        'breathe': 'breathe 4s ease-in-out infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'spin-slow': 'spin 12s linear infinite',
                    },
                    keyframes: {
                        breathe: {
                            '0%, 100%': { opacity: '0.4', transform: 'scale(1)' },
                            '50%': { opacity: '1', transform: 'scale(1.1)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        /* å…¨å±€æ ·å¼å¾®è°ƒ */
        body {
            background-color: #050511;
            color: #E6E6FA;
            overflow: hidden; /* é˜²æ­¢æ»šåŠ¨ */
            -webkit-font-smoothing: antialiased;
        }
        
        /* å™ªç‚¹èƒŒæ™¯çº¹ç† */
        .noise-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 1;
        }

        /* ç£¨ç ‚ç»ç’ƒå¡ç‰‡ */
        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(212, 175, 55, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        /* éšè—æ»šåŠ¨æ¡ */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="h-screen w-screen flex items-center justify-center font-sans relative">

    <div class="noise-bg"></div>

    <div class="fixed top-[-20%] left-[-20%] w-[80vw] h-[80vw] bg-nebula rounded-full blur-[120px] opacity-20 animate-pulse"></div>
    <div class="fixed bottom-[-10%] right-[-10%] w-[60vw] h-[60vw] bg-indigo-900 rounded-full blur-[100px] opacity-20 animate-pulse" style="animation-delay: 2s;"></div>

    <main id="app" class="relative z-10 w-full max-w-md h-full flex flex-col items-center justify-center p-6 transition-opacity duration-1000">
        
        <section id="page-entrance" class="flex flex-col items-center justify-center w-full h-full text-center">
            <div class="mb-8">
                <h1 class="font-serif text-2xl text-gold tracking-[0.2em] mb-4">ECHO</h1>
                <p class="text-slate-400 text-sm tracking-widest font-light opacity-80 mb-8">å‘å®‡å®™æé—®å‰ï¼Œè¯·å…ˆè¯šå®é¢å¯¹è‡ªå·±</p>
            </div>
            
            <!-- æ ‡ç­¾é€‰æ‹© -->
            <div class="flex flex-wrap justify-center gap-3 px-6 mb-8" id="tag-container">
                <button class="tag-btn px-4 py-2 border border-gold/30 text-gold/70 text-sm rounded-full hover:bg-gold/10 hover:border-gold transition-all" data-tag="love_crush">æš§æ˜§/æš—æ‹</button>
                <button class="tag-btn px-4 py-2 border border-gold/30 text-gold/70 text-sm rounded-full hover:bg-gold/10 hover:border-gold transition-all" data-tag="love_partner">ä¼´ä¾£/å¤åˆ</button>
                <button class="tag-btn px-4 py-2 border border-gold/30 text-gold/70 text-sm rounded-full hover:bg-gold/10 hover:border-gold transition-all" data-tag="career_change">è·³æ§½/è¿·èŒ«</button>
                <button class="tag-btn px-4 py-2 border border-gold/30 text-gold/70 text-sm rounded-full hover:bg-gold/10 hover:border-gold transition-all" data-tag="wealth">æé’±/è´¢è¿</button>
                <button class="tag-btn px-4 py-2 border border-gold/30 text-gold/70 text-sm rounded-full hover:bg-gold/10 hover:border-gold transition-all" data-tag="self_growth">è¿‘æœŸæŒ‡å¼•</button>
            </div>
            
            <div class="relative group cursor-pointer" id="start-btn" style="opacity: 0; pointer-events: none;">
                <div class="absolute inset-0 bg-gold rounded-full blur-[20px] opacity-20 group-hover:opacity-40 transition duration-700 animate-breathe"></div>
                <div class="w-24 h-24 rounded-full border border-gold/30 flex items-center justify-center relative bg-void/50 backdrop-blur-sm">
                    <div class="w-16 h-16 rounded-full bg-gradient-to-tr from-nebula to-transparent opacity-80"></div>
                    <svg class="w-8 h-8 text-gold absolute animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                </div>
            </div>
            <p class="text-slate-500 text-xs mt-4" id="start-hint">è¯·å…ˆé€‰æ‹©ä½ çš„é—®é¢˜</p>
        </section>

        <section id="page-ritual" class="hidden flex-col items-center justify-center w-full h-full py-8" style="opacity: 0;">
            <!-- æ ‡é¢˜åŒºåŸŸ - å›ºå®šåœ¨é¡¶éƒ¨ -->
            <div class="text-center mb-8 flex-shrink-0">
                <h2 class="font-serif text-xl text-lavender tracking-widest mb-2">æ´— ç‰Œ</h2>
                <p class="text-xs text-slate-500 font-mono">SHUFFLING THE DESTINY</p>
            </div>

            <!-- å¡ç‰‡åŒºåŸŸ - å±…ä¸­ï¼Œæœ‰è¶³å¤Ÿç©ºé—´ -->
            <div class="relative flex-1 flex items-center justify-center w-full max-w-xs" style="min-height: 300px;">
                <!-- å¤šå±‚å¡ç‰‡å †å æ•ˆæœ -->
                <div class="relative w-40 h-64" id="card-stack">
                    <!-- èƒŒæ™¯å±‚å¡ç‰‡ï¼ˆé™æ€ï¼‰ -->
                    <div class="absolute inset-0 bg-gradient-to-br from-slate-900/40 to-slate-800/40 rounded-xl border border-gold/10 shadow-lg transform rotate-[-8deg] translate-x-[-8px] translate-y-[4px]"></div>
                    <div class="absolute inset-0 bg-gradient-to-br from-slate-900/50 to-slate-800/50 rounded-xl border border-gold/15 shadow-lg transform rotate-[6deg] translate-x-[6px] translate-y-[-4px]"></div>
                    
                    <!-- ä¸»å¡ç‰‡ï¼ˆåŠ¨æ€ï¼‰ -->
                    <div class="absolute inset-0 bg-gradient-to-br from-[#1a1a2e] via-[#16213e] to-[#0f0f1a] rounded-xl border-2 border-gold/40 shadow-2xl flex items-center justify-center overflow-hidden transition-transform duration-300 ease-out" id="deck-card" style="box-shadow: 0 0 30px rgba(212, 175, 55, 0.3), inset 0 0 60px rgba(212, 175, 55, 0.1);">
                        <!-- ç¥ç§˜å›¾æ¡ˆèƒŒæ™¯ -->
                        <div class="absolute inset-0 opacity-20" style="background-image: 
                            radial-gradient(circle at 30% 30%, #D4AF37 2px, transparent 2px),
                            radial-gradient(circle at 70% 70%, #D4AF37 1px, transparent 1px);
                            background-size: 40px 40px, 20px 20px;"></div>
                        
                        <!-- ä¸­å¿ƒèƒ½é‡çƒ -->
                        <div class="relative z-10">
                            <div class="w-16 h-16 rounded-full border-2 border-gold/30 flex items-center justify-center animate-pulse" style="box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);">
                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-gold/20 to-transparent animate-spin-slow"></div>
                            </div>
                        </div>
                        
                        <!-- å…‰æ•ˆè£…é¥° -->
                        <div class="absolute top-0 left-0 w-full h-full pointer-events-none">
                            <div class="absolute top-1/4 left-1/4 w-2 h-2 bg-gold rounded-full animate-pulse" style="animation-delay: 0s; box-shadow: 0 0 10px #D4AF37;"></div>
                            <div class="absolute top-3/4 right-1/4 w-1.5 h-1.5 bg-gold/60 rounded-full animate-pulse" style="animation-delay: 0.5s; box-shadow: 0 0 8px #D4AF37;"></div>
                            <div class="absolute bottom-1/4 left-1/3 w-1 h-1 bg-gold/40 rounded-full animate-pulse" style="animation-delay: 1s; box-shadow: 0 0 6px #D4AF37;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åº•éƒ¨æ§åˆ¶åŒºåŸŸ - å›ºå®šåœ¨åº•éƒ¨ -->
            <div class="text-center mt-8 flex-shrink-0 w-full px-4">
                <p class="text-gold/80 text-sm mb-6 animate-pulse" id="action-text">è¯·æ‘‡æ™ƒæ‰‹æœº</p>
                <div class="w-full max-w-xs mx-auto h-1 bg-white/10 rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full bg-gradient-to-r from-gold/60 via-gold to-gold/60 w-0 transition-all duration-[3000ms] ease-out" style="box-shadow: 0 0 10px rgba(212, 175, 55, 0.6);"></div>
                </div>
            </div>
        </section>

        <section id="page-loading" class="hidden flex-col items-center justify-center w-full h-full" style="opacity: 0;">
            <div class="w-16 h-16 border-t-2 border-l-2 border-gold rounded-full animate-spin mb-8"></div>
            <p id="loading-text" class="font-serif text-slate-300 tracking-widest text-sm">æ­£åœ¨é“¾æ¥æ½œæ„è¯†é¢‘ç‡...</p>
        </section>

        <section id="page-result" class="hidden flex-col w-full h-full py-4 overflow-y-auto hide-scrollbar" style="opacity: 0;">
            <div class="flex justify-between items-center w-full px-4 mb-4 opacity-60">
                <span class="text-[10px] font-mono tracking-widest">2024.03.21</span>
                <span class="text-lg">ğŸŒ˜</span>
            </div>

            <div class="flex justify-center mb-4 transform transition-all duration-1000 translate-y-4 opacity-0" id="result-card-anim">
                <div class="relative" style="width: 200px; height: 320px;">
                    <!-- å¤–å‘å…‰è¾¹æ¡† -->
                    <div class="absolute inset-0 rounded-xl" style="box-shadow: 0 0 20px rgba(212, 175, 55, 0.4), inset 0 0 20px rgba(212, 175, 55, 0.1);"></div>
                    <!-- ä¸»è¾¹æ¡† -->
                    <div class="absolute inset-0 rounded-xl border-2 border-gold/60" style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(212, 175, 55, 0.05) 100%);"></div>
                    <!-- å†…è¾¹æ¡†è£…é¥° -->
                    <div class="absolute inset-[2px] rounded-lg border border-gold/30"></div>
                    <!-- å¡ç‰‡å†…å®¹ -->
                    <div class="relative w-full h-full bg-void/90 rounded-lg overflow-hidden" id="card-content">
                        <div class="absolute inset-0 bg-gradient-to-b from-gray-800 to-black flex items-center justify-center">
                            <span class="font-serif text-6xl opacity-20 text-white">0</span>
                            <p class="absolute bottom-4 text-xs text-white/30 tracking-[0.5em] uppercase">The Fool</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-3 text-center px-4 opacity-0" id="result-text-anim">
                <div>
                    <h2 class="font-serif text-2xl text-gold mb-1.5">æ„š äºº</h2>
                    <div class="flex justify-center gap-2 text-xs text-slate-400 font-light">
                        <span class="border border-white/10 px-2 py-1 rounded">#æ— é™å¯èƒ½</span>
                        <span class="border border-white/10 px-2 py-1 rounded">#ç›²ç›®å‹‡æ°”</span>
                    </div>
                </div>

                <div class="relative py-3">
                    <span class="absolute top-0 left-0 text-3xl text-gold/20 font-serif">"</span>
                    <p class="text-xs leading-relaxed text-slate-200 font-light text-justify px-4">
                        ä½ æ­£ç«™åœ¨æ‚¬å´–è¾¹ç¼˜ï¼Œä½†ä¸å¿…ææƒ§å è½ã€‚ç°åœ¨çš„ä½ æ‹¥æœ‰ä¸€ç§"ä¸çŸ¥å¤©é«˜åœ°åš"çš„å¹¸è¿ï¼Œé€»è¾‘å’Œè§„åˆ’æ­¤åˆ»åªä¼šæŸç¼šä½ ã€‚é—­ä¸Šçœ¼ï¼Œè·³ä¸‹å»ï¼Œé£ä¼šæ¥ä½ä½ ã€‚
                    </p>
                    <span class="absolute bottom-0 right-0 text-3xl text-gold/20 font-serif">"</span>
                </div>

                <div class="bg-white/5 rounded-lg p-3 border border-white/5">
                    <p class="text-xs text-gold/60 mb-1 uppercase tracking-widest">Action</p>
                    <p class="text-xs text-white">åšä¸€ä»¶å¹³æ—¶ç»å¯¹ä¸æ•¢åšçš„å‚»äº‹ã€‚</p>
                </div>

                <div class="flex justify-between items-center pt-3 border-t border-white/10">
                    <div class="text-left">
                        <p class="text-[10px] text-slate-500">å®‡å®™ä¿¡å·</p>
                        <p class="font-mono text-gold text-base">777</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] text-slate-500">å¹¸è¿å…‰æ™•</p>
                        <div class="flex items-center justify-end gap-2">
                            <span class="text-xs text-slate-300">æ˜Ÿå°˜ç™½</span>
                            <div class="w-3 h-3 rounded-full bg-white shadow-[0_0_10px_rgba(255,255,255,0.8)]"></div>
                        </div>
                    </div>
                </div>
            </div>

            <button class="mt-4 w-full py-3 border-2 border-gold text-gold text-sm tracking-[0.2em] uppercase hover:bg-gold hover:text-black transition-colors duration-300 opacity-0" id="save-btn-anim" onclick="saveCard()" style="box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);">
                é¢†å–æŠ¤èº«ç¬¦
            </button>
            
            <button class="mt-3 w-full py-2.5 border border-white/20 text-white/60 text-xs tracking-widest uppercase hover:bg-white/5 transition-colors duration-300 opacity-0" id="retry-btn-anim" onclick="retryDraw()" style="display: none;">
                é‡æ–°æŠ½ç‰Œ
            </button>
            
            <div class="h-12"></div>
        </section>

    </main>

    <script>
        // ========== å…¨å±€çŠ¶æ€ ==========
        let cardsData = [];
        let selectedTag = null;
        let currentResult = null;
        
        // çŠ¶æ€æœº
        const pages = {
            entrance: document.getElementById('page-entrance'),
            ritual: document.getElementById('page-ritual'),
            loading: document.getElementById('page-loading'),
            result: document.getElementById('page-result')
        };

        // ========== å·¥å…·å‡½æ•° ==========
        function switchPage(from, to) {
            from.style.opacity = '0';
            setTimeout(() => {
                from.classList.add('hidden');
                to.classList.remove('hidden');
                void to.offsetWidth; 
                to.style.opacity = '1';
                to.style.transition = 'opacity 0.5s ease-in';
            }, 500);
        }

        // FNV-1a Hashç®—æ³•
        function fnv1aHash(str) {
            let hash = 2166136261;
            for (let i = 0; i < str.length; i++) {
                hash ^= str.charCodeAt(i);
                hash += (hash << 1) + (hash << 4) + (hash << 7) + (hash << 8) + (hash << 24);
            }
            return hash >>> 0; // è½¬ä¸ºæ— ç¬¦å·32ä½æ•´æ•°
        }

        // ç”Ÿæˆçµæ•°ï¼ˆåŸºäºHashï¼‰
        function generateAngelNumber(hash) {
            const numbers = [111, 222, 333, 444, 555, 666, 777, 888, 999, 1212, 1313, 1414];
            return numbers[Math.abs(hash) % numbers.length];
        }

        // ç”Ÿæˆå¹¸è¿è‰²ï¼ˆåŸºäºHashï¼‰
        function generateAuraColor(hash) {
            const colors = [
                { name: 'æ˜Ÿå°˜ç™½', code: '#FFFFFF' },
                { name: 'é¦™æ§Ÿé‡‘', code: '#D4AF37' },
                { name: 'è–°è¡£è‰ç´«', code: '#E6E6FA' },
                { name: 'æ·±ç©ºè“', code: '#2D1B4E' },
                { name: 'ç«ç‘°é‡‘', code: '#E8B4B8' },
                { name: 'æœˆå…‰é“¶', code: '#C0C0C0' },
                { name: 'ç¿¡ç¿ ç»¿', code: '#50C878' },
                { name: 'ç¥ç€æ©™', code: '#FFBF00' }
            ];
            return colors[Math.abs(hash) % colors.length];
        }

        // è·å–å½“å‰æ—¥æœŸ
        function getCurrentDate() {
            const now = new Date();
            return `${now.getFullYear()}.${String(now.getMonth() + 1).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')}`;
        }

        // è·å–æœˆç›¸å›¾æ ‡
        function getMoonPhase() {
            const phases = ['ğŸŒ‘', 'ğŸŒ’', 'ğŸŒ“', 'ğŸŒ”', 'ğŸŒ•', 'ğŸŒ–', 'ğŸŒ—', 'ğŸŒ˜'];
            const day = new Date().getDate();
            return phases[day % phases.length];
        }

        // ========== æ•°æ®åŠ è½½ ==========
        async function loadCardsData() {
            try {
                const response = await fetch('MajorArcana22.json');
                cardsData = await response.json();
                console.log('å¡ç‰Œæ•°æ®åŠ è½½æˆåŠŸ:', cardsData.length, 'å¼ ');
            } catch (error) {
                console.error('åŠ è½½å¡ç‰Œæ•°æ®å¤±è´¥:', error);
                alert('æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // ========== æ ‡ç­¾é€‰æ‹© ==========
        function initTagSelection() {
            const tagButtons = document.querySelectorAll('.tag-btn');
            const startBtn = document.getElementById('start-btn');
            const startHint = document.getElementById('start-hint');
            
            tagButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    // ç§»é™¤å…¶ä»–æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
                    tagButtons.forEach(b => {
                        b.classList.remove('bg-gold', 'text-black', 'border-gold');
                        b.classList.add('border-gold/30', 'text-gold/70');
                    });
                    
                    // é€‰ä¸­å½“å‰æŒ‰é’®
                    btn.classList.add('bg-gold', 'text-black', 'border-gold');
                    btn.classList.remove('border-gold/30', 'text-gold/70');
                    
                    selectedTag = btn.dataset.tag;
                    
                    // æ˜¾ç¤ºå¼€å§‹æŒ‰é’®
                    startBtn.style.opacity = '1';
                    startBtn.style.pointerEvents = 'auto';
                    startHint.textContent = 'ç‚¹å‡»æ³¨å…¥èƒ½é‡ Â· å¼€å¯é“¾æ¥';
                });
            });
        }

        // ========== å¼€å§‹æ—…ç¨‹ ==========
        function startJourney() {
            if (!selectedTag) {
                alert('è¯·å…ˆé€‰æ‹©ä½ çš„é—®é¢˜');
                return;
            }
            
            // è¯·æ±‚é™€èºä»ªæƒé™ï¼ˆiOSï¼‰
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            proceedToRitual();
                        } else {
                            // é™çº§ä¸ºè§¦æ‘¸æ»‘åŠ¨
                            proceedToRitual(true);
                        }
                    })
                    .catch(() => {
                        proceedToRitual(true);
                    });
            } else {
                proceedToRitual();
            }
        }

        function proceedToRitual(useTouch = false) {
            pages.entrance.classList.add('animate-pulse');
            setTimeout(() => {
                switchPage(pages.entrance, pages.ritual);
                startRitualLogic(useTouch);
            }, 800);
        }

        // ========== æ··æ²Œæ´—ç‰Œç®—æ³• ==========
        function startRitualLogic(useTouch = false) {
            const progressBar = document.getElementById('progress-bar');
            const deckCard = document.getElementById('deck-card');
            const actionText = document.getElementById('action-text');
            
            // ç†µæ•°æ®æ”¶é›†
            let entropyData = [];
            let lastSampleTime = Date.now();
            let lastX = 0, lastY = 0;
            let lastAlpha = 0, lastBeta = 0, lastGamma = 0;
            
            // è¿›åº¦æ¡åœ¨3ç§’å†…é€æ¸å¡«æ»¡
            progressBar.style.width = '0%';
            setTimeout(() => {
                progressBar.style.width = '100%';
            }, 50);

            // æ•°æ®é‡‡æ ·å‡½æ•°ï¼ˆæ¯100msé‡‡æ ·ä¸€æ¬¡ï¼‰
            function sampleData() {
                const now = Date.now();
                const timestamp = now;
                
                if (useTouch) {
                    // è§¦æ‘¸æ¨¡å¼ï¼šä½¿ç”¨é¼ æ ‡/è§¦æ‘¸ä½ç½®
                    entropyData.push({
                        x: lastX,
                        y: lastY,
                        time: timestamp
                    });
                } else {
                    // é™€èºä»ªæ¨¡å¼ï¼šä½¿ç”¨è®¾å¤‡è¿åŠ¨æ•°æ®
                    entropyData.push({
                        alpha: lastAlpha,
                        beta: lastBeta,
                        gamma: lastGamma,
                        time: timestamp
                    });
                }
            }

            // é¼ æ ‡/è§¦æ‘¸äº‹ä»¶ç›‘å¬
            let mouseMoveHandler, touchMoveHandler;
            
            if (useTouch) {
                actionText.textContent = 'è¯·ç”¨æ‰‹æŒ‡åœ¨å±å¹•ç”»åœ†';
                
                mouseMoveHandler = (e) => {
                    lastX = e.clientX;
                    lastY = e.clientY;
                };
                
                touchMoveHandler = (e) => {
                    if (e.touches.length > 0) {
                        lastX = e.touches[0].clientX;
                        lastY = e.touches[0].clientY;
                    }
                };
                
                document.addEventListener('mousemove', mouseMoveHandler);
                document.addEventListener('touchmove', touchMoveHandler);
            } else {
                actionText.textContent = 'è¯·æ‘‡æ™ƒæ‰‹æœº';
                
                // é™€èºä»ªäº‹ä»¶ç›‘å¬
                const deviceMotionHandler = (e) => {
                    if (e.rotationRate) {
                        lastAlpha = e.rotationRate.alpha || 0;
                        lastBeta = e.rotationRate.beta || 0;
                        lastGamma = e.rotationRate.gamma || 0;
                    }
                };
                
                window.addEventListener('devicemotion', deviceMotionHandler);
                
                // æ¸…ç†å‡½æ•°
                window.cleanupDeviceMotion = () => {
                    window.removeEventListener('devicemotion', deviceMotionHandler);
                };
            }

            // é‡‡æ ·å®šæ—¶å™¨ï¼ˆæ¯100msï¼‰
            const sampleInterval = setInterval(sampleData, 100);
            
            // è§†è§‰åé¦ˆå®šæ—¶å™¨ï¼ˆæ¯150msï¼Œæ›´æµç•…çš„åŠ¨ç”»ï¼‰
            let shakeCount = 0;
            let lastRotation = 0;
            let lastTranslateX = 0;
            let lastTranslateY = 0;
            
            const visualInterval = setInterval(() => {
                shakeCount++;
                
                // è®¡ç®—è¿›åº¦ï¼ˆ0-1ï¼‰
                const progress = shakeCount / 20; // 3ç§’ = 20æ¬¡ * 150ms
                
                // æ ¹æ®è¿›åº¦è°ƒæ•´åŠ¨ç”»å¼ºåº¦ï¼ˆå¼€å§‹å¼ºçƒˆï¼Œé€æ¸å‡å¼±ï¼‰
                const intensity = 1 - (progress * 0.3); // ä»1.0åˆ°0.7
                
                // å¹³æ»‘çš„éšæœºæ—‹è½¬ï¼ˆä½¿ç”¨ç¼“åŠ¨ï¼Œé¿å…çªå˜ï¼‰
                const targetRot = (Math.random() * 12 - 6) * intensity;
                const targetX = (Math.random() * 12 - 6) * intensity;
                const targetY = (Math.random() * 8 - 4) * intensity;
                
                // å¹³æ»‘è¿‡æ¸¡ï¼ˆé¿å…çªç„¶è·³åŠ¨ï¼‰
                lastRotation = lastRotation * 0.6 + targetRot * 0.4;
                lastTranslateX = lastTranslateX * 0.6 + targetX * 0.4;
                lastTranslateY = lastTranslateY * 0.6 + targetY * 0.4;
                
                // æ·»åŠ è½»å¾®çš„ç¼©æ”¾æ•ˆæœï¼ˆå‘¼å¸æ„Ÿï¼‰
                const scale = 1 + Math.sin(shakeCount * 0.3) * 0.02;
                
                // åº”ç”¨å˜æ¢
                deckCard.style.transform = `
                    rotate(${lastRotation}deg) 
                    translate(${lastTranslateX}px, ${lastTranslateY}px)
                    scale(${scale})
                `;
                
                // æ·»åŠ å…‰æ•ˆå¼ºåº¦å˜åŒ–
                const glowIntensity = 0.3 + Math.sin(shakeCount * 0.5) * 0.2;
                deckCard.style.boxShadow = `
                    0 0 ${30 * glowIntensity}px rgba(212, 175, 55, ${0.3 * glowIntensity}),
                    inset 0 0 ${60 * glowIntensity}px rgba(212, 175, 55, ${0.1 * glowIntensity})
                `;
                
                // éœ‡åŠ¨åé¦ˆï¼ˆåªåœ¨ç‰¹å®šæ—¶æœºï¼‰
                if (navigator.vibrate && !useTouch && shakeCount % 3 === 0) {
                    navigator.vibrate(30);
                }
                
                if (shakeCount >= 20) { // 3ç§’åï¼ˆ20æ¬¡ * 150ms = 3000msï¼‰
                    clearInterval(sampleInterval);
                    clearInterval(visualInterval);
                    
                    // æ¸…ç†äº‹ä»¶ç›‘å¬
                    if (useTouch) {
                        document.removeEventListener('mousemove', mouseMoveHandler);
                        document.removeEventListener('touchmove', touchMoveHandler);
                    } else if (window.cleanupDeviceMotion) {
                        window.cleanupDeviceMotion();
                    }
                    
                    // æœ€ç»ˆåŠ¨ç”»ï¼šå¡ç‰‡å›åˆ°ä¸­å¿ƒå¹¶æ”¾å¤§
                    deckCard.style.transition = 'transform 0.5s ease-out, box-shadow 0.5s ease-out';
                    deckCard.style.transform = 'rotate(0deg) translate(0, 0) scale(1.05)';
                    deckCard.style.boxShadow = '0 0 40px rgba(212, 175, 55, 0.5), inset 0 0 80px rgba(212, 175, 55, 0.2)';
                    
                    // å»¶è¿Ÿåè¿›å…¥åŠ è½½é¡µ
                    setTimeout(() => {
                        // è®¡ç®—Hashå¹¶æŠ½å–å¡ç‰Œ
                        const hash = calculateHash(entropyData);
                        const result = drawCard(hash);
                        finishRitual(result);
                    }, 500);
                }
            }, 150);
        }

        // è®¡ç®—Hashå€¼
        function calculateHash(entropyData) {
            if (entropyData.length === 0) {
                // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºåå¤‡
                entropyData = [{ time: Date.now(), x: Math.random(), y: Math.random() }];
            }
            
            // æ„å»ºç†µå­—ç¬¦ä¸²
            let entropyString = '';
            entropyData.forEach(data => {
                if (data.x !== undefined) {
                    entropyString += `${data.x},${data.y},${data.time}`;
                } else {
                    entropyString += `${data.alpha},${data.beta},${data.gamma},${data.time}`;
                }
            });
            
            // æ·»åŠ é¢å¤–ç†µæº
            entropyString += Date.now().toString();
            entropyString += Math.random().toString();
            
            return fnv1aHash(entropyString);
        }

        // æŠ½å–å¡ç‰Œ
        function drawCard(hash) {
            const cardIndex = Math.abs(hash) % 22;
            const isReversed = (hash % 2 !== 0);
            const card = cardsData[cardIndex];
            
            return {
                card: card,
                isReversed: isReversed,
                hash: hash
            };
        }

        // ========== å®Œæˆä»ªå¼ -> è¿›å…¥ä¼ªåŠ è½½ ==========
        function finishRitual(result) {
            currentResult = result;
            switchPage(pages.ritual, pages.loading);
            
            const loadingText = document.getElementById('loading-text');
            const phrases = [
                "æ­£åœ¨é“¾æ¥æ½œæ„è¯†é¢‘ç‡...",
                "æ•æ‰ç¯å¢ƒç£åœºç†µå€¼...",
                "æ˜Ÿå›¾çŸ©é˜µæ ¡å‡†ä¸­...",
                "è§£è¯»å®Œæˆã€‚"
            ];
            
            let i = 0;
            const textInterval = setInterval(() => {
                if (i < phrases.length) {
                loadingText.innerText = phrases[i];
                i++;
                } else {
                    clearInterval(textInterval);
                }
            }, 800);

            // 3.2ç§’åæ˜¾ç¤ºç»“æœ
            setTimeout(() => {
                showResult(result);
            }, 3200);
        }

        // ========== æ˜¾ç¤ºç»“æœ ==========
        function showResult(result) {
            switchPage(pages.loading, pages.result);
            
            const card = result.card;
            const isReversed = result.isReversed;
            const hash = result.hash;
            
            // è°ƒè¯•ä¿¡æ¯ï¼šåœ¨æ§åˆ¶å°æ˜¾ç¤ºå¡ç‰Œä¿¡æ¯
            console.log('========== å¡ç‰Œä¿¡æ¯ ==========');
            console.log('å¡ç‰ŒID:', card.id);
            console.log('å¡ç‰Œåç§°:', card.name_cn);
            console.log('Hashå€¼:', hash);
            console.log('Hash % 2 =', hash % 2);
            console.log('æ˜¯å¦é€†ä½:', isReversed);
            console.log('å›¾ç‰‡æ—‹è½¬:', isReversed ? '180deg (é€†ä½ - å›¾ç‰‡åº”å€’ç½®)' : '0deg (æ­£ä½ - å›¾ç‰‡åº”æ­£å¸¸)');
            console.log('============================');
            
            // æ›´æ–°æ—¥æœŸå’Œæœˆç›¸
            const headerDiv = pages.result.querySelector('.flex.justify-between.items-center');
            if (headerDiv) {
                const dateElement = headerDiv.querySelector('span.font-mono');
                const moonElement = headerDiv.querySelector('span.text-lg');
                if (dateElement) dateElement.textContent = getCurrentDate();
                if (moonElement) moonElement.textContent = getMoonPhase();
            }
            
            // æ›´æ–°å¡ç‰Œå›¾ç‰‡ï¼ˆå»¶è¿ŸåŠ è½½ï¼ŒåªåŠ è½½å½“å‰éœ€è¦çš„ï¼‰
            const cardContainer = document.querySelector('#card-content');
            if (cardContainer) {
                // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                cardContainer.innerHTML = '<div class="absolute inset-0 flex items-center justify-center bg-void/50"><div class="w-8 h-8 border-t-2 border-l-2 border-gold rounded-full animate-spin"></div></div>';
                
                const img = document.createElement('img');
                // æ„å»ºæ–‡ä»¶åï¼Œä½¿ç”¨å‹ç¼©åçš„WebPæ ¼å¼
                const fileName = `${card.id}. ${card.name_cn} (${card.name_en}).webp`;
                img.alt = card.name_cn;
                img.className = 'w-full h-full object-cover';
                
                // è®¾ç½®æ—‹è½¬ï¼šæ­£ä½ä¸æ—‹è½¬ï¼ˆå®Œå…¨ä¸è®¾ç½®transformï¼‰ï¼Œé€†ä½æ—‹è½¬180åº¦
                const setRotation = () => {
                    if (isReversed) {
                        img.style.transform = 'rotate(180deg)';
                        img.style.transformOrigin = 'center center';
                    } else {
                        // æ­£ä½ï¼šå®Œå…¨æ¸…é™¤transformï¼Œç¡®ä¿å›¾ç‰‡æ­£å¸¸æ˜¾ç¤º
                        img.style.transform = '';
                        img.style.transformOrigin = '';
                    }
                };
                
                // å›¾ç‰‡åŠ è½½å®Œæˆåçš„å¤„ç†
                const loadStartTime = performance.now();
                img.onload = () => {
                    const loadTime = performance.now() - loadStartTime;
                    setRotation();
                    // ç§»é™¤åŠ è½½åŠ¨ç”»ï¼Œæ˜¾ç¤ºå›¾ç‰‡
                    cardContainer.innerHTML = '';
                    cardContainer.appendChild(img);
                    console.log(`å›¾ç‰‡åŠ è½½å®Œæˆï¼Œè€—æ—¶: ${loadTime.toFixed(2)}msï¼Œæ—‹è½¬çŠ¶æ€:`, isReversed ? '180deg (é€†ä½)' : 'æ— æ—‹è½¬ (æ­£ä½)');
                };
                
                img.onerror = function() {
                    // å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºå ä½ç¬¦
                    cardContainer.innerHTML = '';
                    const placeholder = document.createElement('div');
                    placeholder.className = 'absolute inset-0 bg-gradient-to-b from-gray-800 to-black flex items-center justify-center';
                    placeholder.innerHTML = `
                        <span class="font-serif text-6xl opacity-20 text-white">${card.id}</span>
                        <p class="absolute bottom-4 text-xs text-white/30 tracking-[0.5em] uppercase">${card.name_en}</p>
                    `;
                    cardContainer.appendChild(placeholder);
                };
                
                // å¼€å§‹åŠ è½½å›¾ç‰‡ï¼ˆå»¶è¿ŸåŠ è½½ï¼ŒåªåŠ è½½å½“å‰éœ€è¦çš„ï¼Œä½¿ç”¨å‹ç¼©åçš„WebPæ ¼å¼ï¼‰
                img.src = `cards_small/${fileName}`;
            }
            
            // æ›´æ–°å¡ç‰Œåç§°å’Œæ­£é€†ä½æ ‡å¿—
            const nameElement = document.querySelector('#result-text-anim h2');
            if (nameElement) {
                const positionText = isReversed ? 'é€†ä½' : 'æ­£ä½';
                const positionClass = isReversed ? 'text-red-400' : 'text-green-400';
                const positionBg = isReversed ? 'bg-red-500/20' : 'bg-green-500/20';
                nameElement.innerHTML = `
                    ${card.name_cn}
                    <span class="ml-3 text-base ${positionClass} font-normal px-3 py-1 rounded-full ${positionBg} border ${isReversed ? 'border-red-500/50' : 'border-green-500/50'}">
                        ${positionText}
                    </span>
                `;
            }
            
            // æ›´æ–°å…³é”®è¯
            const keywords = isReversed ? card.keywords.reversed : card.keywords.upright;
            const keywordsContainer = document.querySelector('#result-text-anim .flex.gap-3');
            if (keywordsContainer) {
                keywordsContainer.innerHTML = '';
                const selectedKeywords = keywords.slice(0, 2);
                selectedKeywords.forEach(keyword => {
                    const span = document.createElement('span');
                    span.className = 'border border-white/10 px-2 py-1 rounded text-xs text-slate-400 font-light';
                    span.textContent = `#${keyword}`;
                    keywordsContainer.appendChild(span);
                });
            }
            
            // æ›´æ–°æ–‡æ¡ˆ
            const message = isReversed ? card.message.reversed : card.message.upright;
            const messageElement = document.querySelector('#result-text-anim .relative.py-4 p.text-sm');
            if (messageElement) messageElement.textContent = message;
            
            // æ›´æ–°è¡ŒåŠ¨å»ºè®®
            const action = isReversed ? card.action_item.reversed : card.action_item.upright;
            const actionElement = document.querySelector('#result-text-anim .bg-white\\/5 p.text-sm.text-white');
            if (actionElement) actionElement.textContent = action;
            
            // æ›´æ–°ç¤¾äº¤è´§å¸æŒ‚ä»¶
            const angelNumber = generateAngelNumber(hash);
            const auraColor = generateAuraColor(hash);
            
            const numberElement = document.querySelector('#result-text-anim .font-mono.text-lg');
            const colorNameElement = document.querySelector('#result-text-anim .text-xs.text-slate-300');
            const colorDot = document.querySelector('#result-text-anim .w-3.h-3');
            
            if (numberElement) numberElement.textContent = angelNumber;
            if (colorNameElement) colorNameElement.textContent = auraColor.name;
            if (colorDot) {
                colorDot.style.backgroundColor = auraColor.code;
                colorDot.style.boxShadow = `0 0 10px ${auraColor.code}80`;
            }
            
            // ä¾æ¬¡æµ®ç°å…ƒç´ 
            setTimeout(() => {
                document.getElementById('result-card-anim').classList.remove('translate-y-4', 'opacity-0');
            }, 100);
            
            setTimeout(() => {
                document.getElementById('result-text-anim').classList.remove('opacity-0');
                document.getElementById('result-text-anim').classList.add('animate-float');
            }, 600);

            setTimeout(() => {
                document.getElementById('save-btn-anim').classList.remove('opacity-0');
                document.getElementById('retry-btn-anim').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('retry-btn-anim').classList.remove('opacity-0');
                }, 100);
            }, 1200);
        }

        // ========== ä¿å­˜å¡ç‰‡ ==========
        async function saveCard() {
            // ä½¿ç”¨html2canvasç”Ÿæˆå›¾ç‰‡
            try {
                // åŠ¨æ€åŠ è½½html2canvasåº“ï¼ˆä¼˜å…ˆä½¿ç”¨å›½å†…è®¿é—®è¾ƒå¿«çš„CDNï¼‰
                if (typeof html2canvas === 'undefined') {
                    const script = document.createElement('script');
                    // ä¼˜å…ˆä½¿ç”¨jsdelivrï¼ˆå›½å†…è®¿é—®è¾ƒå¿«ï¼‰ï¼Œå¤±è´¥åˆ™å°è¯•unpkg
                    script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
                    script.crossOrigin = 'anonymous';
                    document.head.appendChild(script);
                    await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            // è¶…æ—¶åå°è¯•å¤‡ç”¨CDN
                            const fallbackScript = document.createElement('script');
                            fallbackScript.src = 'https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js';
                            fallbackScript.crossOrigin = 'anonymous';
                            document.head.appendChild(fallbackScript);
                            fallbackScript.onload = () => {
                                clearTimeout(timeout);
                                resolve();
                            };
                            fallbackScript.onerror = () => reject(new Error('æ— æ³•åŠ è½½html2canvasåº“'));
                        }, 5000); // 5ç§’è¶…æ—¶
                        
                        script.onload = () => {
                            clearTimeout(timeout);
                            resolve();
                        };
                        script.onerror = () => {
                            clearTimeout(timeout);
                            // å¦‚æœjsdelivrå¤±è´¥ï¼Œç«‹å³å°è¯•unpkg
                            const fallbackScript = document.createElement('script');
                            fallbackScript.src = 'https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js';
                            fallbackScript.crossOrigin = 'anonymous';
                            document.head.appendChild(fallbackScript);
                            fallbackScript.onload = () => resolve();
                            fallbackScript.onerror = () => reject(new Error('æ— æ³•åŠ è½½html2canvasåº“'));
                        };
                    });
                }
                
                const resultSection = document.getElementById('page-result');
                const canvas = await html2canvas(resultSection, {
                    backgroundColor: '#050511',
                    scale: 2,
                    useCORS: true,
                    logging: false
                });
                
                // è½¬æ¢ä¸ºå›¾ç‰‡å¹¶ä¸‹è½½
                const link = document.createElement('a');
                link.download = `echo-${currentResult.card.id}-${Date.now()}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
            } catch (error) {
                console.error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥:', error);
                alert('ç”Ÿæˆå›¾ç‰‡å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // ========== é‡æ–°æŠ½ç‰Œ ==========
        function retryDraw() {
            // é‡ç½®çŠ¶æ€
            selectedTag = null;
            currentResult = null;
            
            // é‡ç½®UI
            document.querySelectorAll('.tag-btn').forEach(btn => {
                btn.classList.remove('bg-gold', 'text-black', 'border-gold');
                btn.classList.add('border-gold/30', 'text-gold/70');
            });
            
            document.getElementById('start-btn').style.opacity = '0';
            document.getElementById('start-btn').style.pointerEvents = 'none';
            document.getElementById('start-hint').textContent = 'è¯·å…ˆé€‰æ‹©ä½ çš„é—®é¢˜';
            
            // é‡ç½®ç»“æœé¡µ
            document.getElementById('result-card-anim').classList.add('translate-y-4', 'opacity-0');
            document.getElementById('result-text-anim').classList.add('opacity-0');
            document.getElementById('save-btn-anim').classList.add('opacity-0');
            document.getElementById('retry-btn-anim').classList.add('opacity-0');
            document.getElementById('retry-btn-anim').style.display = 'none';
            
            // è¿”å›å…¥å£é¡µ
            switchPage(pages.result, pages.entrance);
        }

        // ========== å›¾ç‰‡é¢„åŠ è½½ï¼ˆå»¶è¿ŸåŠ è½½ï¼ŒåªåŠ è½½å½“å‰éœ€è¦çš„ï¼‰==========
        function preloadCardImage(cardId, nameCn, nameEn) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const fileName = `${cardId}. ${nameCn} (${nameEn}).webp`;
                img.src = `cards_small/${fileName}`;
                img.onload = () => resolve(img);
                img.onerror = reject;
            });
        }

        // ========== åˆå§‹åŒ– ==========
        document.addEventListener('DOMContentLoaded', async () => {
            // æ˜¾ç¤ºåŠ è½½æç¤º
            console.log('å¼€å§‹åŠ è½½æ•°æ®...');
            const startTime = performance.now();
            
            await loadCardsData();
            
            const loadTime = performance.now() - startTime;
            console.log(`æ•°æ®åŠ è½½å®Œæˆï¼Œè€—æ—¶: ${loadTime.toFixed(2)}ms`);
            
            initTagSelection();
            
            // ç»‘å®šå¼€å§‹æŒ‰é’®
            document.getElementById('start-btn').addEventListener('click', startJourney);
        });
    </script>
</body>
</html>